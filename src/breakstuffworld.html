<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Cannon Scene with First-Person Controls</title>
    <script src="/lib/phaser.min.js?ver=3.52.0"></script>
    <script src="/lib/enable3d/enable3d.phaserExtension.0.25.4.min.js"></script>
  </head>

  <body>
    <script>
      const { enable3d, Scene3D, Canvas, THREE } = ENABLE3D;

      class CannonScene extends Scene3D {
        constructor() {
          super({ key: 'CannonScene' });
        }

        init() {
          this.accessThirdDimension();
        }

        async create() {
          try {
            // Camera setup for first-person controls
            this.third.camera.position.set(0, 2, 5);
            this.third.camera.lookAt(0, 2, 0);
            this.third.controls = new THREE.PointerLockControls(this.third.camera, this.third.renderer.domElement);

            // Click to enable first-person controls
            this.input.on('pointerdown', () => {
              this.third.controls.lock();
            });

            // Basic lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(10, 20, 10);
            this.third.add.existing(ambientLight);
            this.third.add.existing(directionalLight);

            // Load and add cannon model with shooting animation
            await this.addCannon();
          } catch (error) {
            console.error('Error creating scene:', error);
          }
        }

        async addCannon() {
          const loader = new THREE.GLTFLoader();
          loader.load('/src/assets/glb/cannon2.glb', (gltf) => {
            const cannon = gltf.scene;
            this.third.add.existing(cannon);

            // Find and reference the cannon barrel (gunbbody8)
            this.cannonBarrel = cannon.getObjectByName('gunbbody8');

            // Add muzzle flash light to the barrel
            this.muzzleFlash = new THREE.PointLight(0xffa500, 2, 10);
            this.muzzleFlash.position.set(0, 0, 1); // Position it at the end of the barrel
            this.muzzleFlash.visible = false; // Initially invisible
            this.cannonBarrel.add(this.muzzleFlash);

            // Add recoil and flash animation
            this.shootAnimation();
          });
        }

        shootAnimation() {
          this.input.on('pointerdown', () => {
            if (!this.cannonBarrel) return;

            // Muzzle flash effect
            this.muzzleFlash.visible = true;
            setTimeout(() => { this.muzzleFlash.visible = false; }, 100); // Flash visible for 100ms

            // Recoil animation for the cannon barrel
            const startPosZ = this.cannonBarrel.position.z;
            const recoilDistance = 0.5;

            this.third.tweens.add({
              targets: this.cannonBarrel.position,
              z: startPosZ - recoilDistance, // Move backward
              duration: 50, // Recoil back in 50ms
              yoyo: true, // Return to original position
              onComplete: () => {
                this.cannonBarrel.position.z = startPosZ; // Reset position
              }
            });
          });
        }
      }

      // Phaser configuration
      const config = {
        type: Phaser.WEBGL,
        transparent: true,
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
          width: window.innerWidth,
          height: window.innerHeight,
        },
        scene: [CannonScene],
        canvas: document.createElement('canvas'),
        ...Canvas(),
      };

      // Load Enable3D and Phaser when the page is ready
      window.addEventListener('load', () => {
        enable3d(() => new Phaser.Game(config)).withPhysics('/lib/ammo/kripken');
      });

      // Handle viewport resizing
      window.addEventListener('resize', () => {
        const newWidth = window.innerWidth;
        const newHeight = window.innerHeight;
        const game = Phaser.Game(config);

        game.scale.resize(newWidth, newHeight);
        game.scene.scenes.forEach((scene) => {
          if (scene.cameras && scene.cameras.main) {
            scene.cameras.main.setSize(newWidth, newHeight);
          }
        });
      });
    </script>
  </body>
</html>
